<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>マナー学習チャットボット デモ</title>
    
    <!-- Tailwind CSSとGoogle Fontsの読み込み -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+JP:wght@400;500;700&family=Noto+Sans+SC:wght@400;500;700&display=swap" rel="stylesheet">
    
    <style>
        body {
            font-family: 'Inter', 'Noto Sans JP', 'Noto Sans SC', sans-serif;
        }
        #chat-window::-webkit-scrollbar { width: 8px; }
        #chat-window::-webkit-scrollbar-track { background: #f1f5f9; }
        #chat-window::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 4px; }
        #chat-window::-webkit-scrollbar-thumb:hover { background: #64748b; }
        .bot-response-dos { color: #16a34a; /* Green */ }
        .bot-response-donts { color: #dc2626; /* Red */ }
    </style>
</head>

<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">

    <div class="w-full max-w-lg mx-auto bg-white rounded-2xl shadow-2xl flex flex-col h-[90vh] max-h-[750px]">
        
        <!-- ヘッダー -->
        <header class="bg-green-700 text-white p-4 rounded-t-2xl shadow-md flex justify-between items-center">
            <div>
                <h1 id="header-title" class="text-xl font-bold">マナー学習ボット</h1>
                <p id="header-lang-status" class="text-sm opacity-90">言語: 日本語</p>
            </div>
            <div id="language-switcher" class="flex space-x-1 sm:space-x-2">
                <button onclick="switchLanguage('ja')" class="ja-btn bg-white text-green-700 font-bold py-1 px-3 rounded-full text-sm shadow-sm transition-transform transform scale-110 ring-2 ring-white">日本語</button>
                <button onclick="switchLanguage('en')" class="en-btn bg-green-600 hover:bg-white hover:text-green-700 font-bold py-1 px-3 rounded-full text-sm shadow-sm transition-transform transform hover:scale-110">EN</button>
                <button onclick="switchLanguage('zh')" class="zh-btn bg-green-600 hover:bg-white hover:text-green-700 font-bold py-1 px-3 rounded-full text-sm shadow-sm transition-transform transform hover:scale-110">中文</button>
            </div>
        </header>

        <!-- チャットウィンドウ -->
        <main id="chat-window" class="flex-1 p-6 overflow-y-auto space-y-4 bg-gray-50">
            <!-- メッセージはここに動的に追加 -->
        </main>

        <!-- 入力フォーム -->
        <footer class="p-4 bg-white border-t border-gray-200 rounded-b-2xl">
            <div class="flex items-center space-x-3">
                <input type="text" id="user-input" class="flex-1 p-3 border border-gray-300 rounded-full focus:outline-none focus:ring-2 focus:ring-green-500 transition" placeholder="「食事のマナー」のように入力">
                <button id="send-btn" class="bg-green-600 text-white rounded-full p-3 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition-transform transform hover:scale-110">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" /></svg>
                </button>
            </div>
        </footer>
    </div>

<script>
    // --- グローバル変数 ---
    let currentLanguage = 'ja';
    let inquiryState = {
        status: 'idle', // idle, awaiting_name, awaiting_email, awaiting_message
        name: '',
        email: '',
        message: ''
    };

    // --- DOM要素 ---
    const chatWindow = document.getElementById('chat-window');
    const userInput = document.getElementById('user-input');
    const sendBtn = document.getElementById('send-btn');
    const langSwitcher = document.getElementById('language-switcher');

    // --- 多言語UIテキスト ---
    const uiStrings = {
        ja: {
            headerTitle: 'マナー学習ボット',
            langStatus: '言語: 日本語',
            inputPlaceholder: '「食事のマナー」のように入力',
            welcome: {
                message: 'こんにちは！日本のマナーについて、どんなことを知りたいですか？下のボタンから選ぶか、キーワードを入力してください。',
                replies: ['食事', '電車', 'クイズ', 'お問い合わせ']
            },
            defaultReply: '申し訳ありません、そのキーワードに関する情報は見つかりませんでした。別の言葉でお試しください。',
            back_to_menu: 'メニューに戻る',
            inquiry: {
                start: 'お問い合わせですね。承知いたしました。まず、お名前を教えていただけますか？（途中で「キャンセル」と入力すると中断できます）',
                prompt_email: 'ありがとうございます。次に、ご連絡先のメールアドレスをお願いします。',
                prompt_message: '承知いたしました。最後にお問い合わせ内容をご記入ください。',
                complete: 'お問い合わせいただき、ありがとうございます。担当者より追ってご連絡いたします。',
                invalid_email: '申し訳ありませんが、メールアドレスの形式が正しくないようです。もう一度入力していただけますか？',
                send_error: '申し訳ありません、送信中にエラーが発生しました。時間をおいて再度お試しください。',
                cancelled: 'お問い合わせをキャンセルしました。',
                cancel_keywords: ['キャンセル', 'やめる'],
            }
        },
        en: {
            headerTitle: 'Manners Learning Bot',
            langStatus: 'Language: English',
            inputPlaceholder: 'e.g., "dining manners"',
            welcome: {
                message: 'Hello! What would you like to know about Japanese manners? Choose from the buttons below or type a keyword.',
                replies: ['Dining', 'Trains', 'Quiz', 'Contact']
            },
            defaultReply: "I'm sorry, I couldn't find information on that topic. Please try another keyword.",
            back_to_menu: 'Back to Menu',
            inquiry: {
                start: 'Okay, you want to make an inquiry. First, could you please tell me your name? (You can type "cancel" to stop at any time)',
                prompt_email: 'Thank you. Next, please provide your email address.',
                prompt_message: 'Got it. Finally, please enter your message.',
                complete: 'Thank you for your inquiry. Our team will get back to you shortly.',
                invalid_email: "I'm sorry, but the email address format seems incorrect. Could you please enter it again?",
                send_error: 'Sorry, an error occurred while sending. Please try again later.',
                cancelled: 'The inquiry has been cancelled.',
                cancel_keywords: ['cancel', 'stop'],
            }
        },
        zh: {
            headerTitle: '礼仪学习机器人',
            langStatus: '语言: 中文',
            inputPlaceholder: '例如输入“餐饮礼仪”',
            welcome: {
                message: '您好！关于日本的礼仪，您想了解什么？请从下面的按钮中选择或输入关键词。',
                replies: ['餐饮', '电车', '测验', '联系我们']
            },
            defaultReply: '很抱歉，未能找到相关信息。请换个关键词试试。',
            back_to_menu: '返回菜单',
            inquiry: {
                start: '好的，您想进行咨询。首先，请问您的名字是？（您可以随时输入“取消”来中断）',
                prompt_email: '谢谢。接下来，请输入您的电子邮件地址。',
                prompt_message: '好的。最后，请输入您的咨询内容。',
                complete: '感谢您的咨询，相关人员会尽快与您联系。',
                invalid_email: '抱歉，电子邮件地址的格式似乎不正确，可以请您再输入一次吗？',
                send_error: '抱歉，发送时发生错误，请稍后再试。',
                cancelled: '咨询已取消。',
                cancel_keywords: ['取消'],
            }
        }
    };

    // --- ナレッジベース ---
    const knowledgeBase = {
        ja: {
            '食事': { dos: ['「いただきます」「ごちそうさま」を言う', 'お箸を正しく持つ'], donts: ['箸をご飯に突き刺す（立て箸）', '音を立てて食べる'], link: '/articles/dining-etiquette' },
            '電車': { dos: ['静かに乗車する', 'お年寄りや妊婦の方に席を譲る'], donts: ['車内で大声で話す', '大きな荷物で通路をふさぐ'], link: '/articles/train-manners' },
            'クイズ': { isQuiz: true, question: 'レストランで、入り口から一番遠い席は誰が座る席でしょうか？', options: ['一番偉い人', '一番若い人', '誰でも良い'], correct: '一番偉い人', explanation: '日本では、入り口から最も遠い席が「上座（かみざ）」とされ、最も敬意を払うべき人が座るのが一般的です。' },
            'お問い合わせ': { isInquiry: true }
        },
        en: {
            'dining': { dos: ['Say "itadakimasu" and "gochisosama"', 'Hold chopsticks correctly'], donts: ['Sticking chopsticks upright in your rice', 'Making loud noises while eating'], link: '/en/articles/dining-etiquette' },
            'trains': { dos: ['Be quiet on the train', 'Offer your seat to the elderly'], donts: ['Talking loudly or on the phone', 'Blocking the aisle with large luggage'], link: '/en/articles/train-manners' },
            'quiz': { isQuiz: true, question: 'In a restaurant, who sits in the seat furthest from the entrance?', options: ['The most important person', 'The youngest person', 'Anyone'], correct: 'The most important person', explanation: 'In Japan, the seat furthest from the entrance is called "kamiza," and it is for the most respected person.' },
            'contact': { isInquiry: true }
        },
        zh: {
            '餐饮': { dos: ['吃饭前后说“我开动了”和“我吃好了”', '正确使用筷子'], donts: ['把筷子插在米饭上', '吃饭时发出很大声音'], link: '/zh/articles/dining-etiquette' },
            '电车': { dos: ['安静乘车', '给老人或孕妇让座'], donts: ['在车厢内大声说话或打电话', '用大件行李堵住通道'], link: '/zh/articles/train-manners' },
            '测验': { isQuiz: true, question: '在餐厅里，离入口最远的座位是给谁坐的？', options: ['地位最高的人', '最年轻的人', '任何人都可以'], correct: '地位最高的人', explanation: '在日本，离入口最远的座位被称为“上座”，通常是给最应受尊敬的人坐的。' },
            '联系我们': { isInquiry: true }
        }
    };
    
    // --- 関数定義 ---

    /** お問い合わせの状態をリセット */
    function resetInquiryState() {
        inquiryState = { status: 'idle', name: '', email: '', message: '' };
    }
    
    /** ウェルカムメニューを表示 */
    function showWelcomeMenu() {
        const welcome = uiStrings[currentLanguage].welcome;
        displayBotMessage(welcome.message, { quickReplies: welcome.replies });
    }

    /** 言語を切り替える */
    function switchLanguage(lang) {
        currentLanguage = lang;
        resetInquiryState();
        const strings = uiStrings[lang];
        document.getElementById('header-title').textContent = strings.headerTitle;
        document.getElementById('header-lang-status').textContent = strings.langStatus;
        userInput.placeholder = strings.inputPlaceholder;

        const buttons = langSwitcher.querySelectorAll('button');
        buttons.forEach(btn => {
            btn.classList.remove('bg-white', 'text-green-700', 'scale-110', 'ring-2', 'ring-white');
            btn.classList.add('bg-green-600', 'hover:bg-white', 'hover:text-green-700');
            if (btn.classList.contains(`${lang}-btn`)) {
                btn.classList.add('bg-white', 'text-green-700', 'scale-110', 'ring-2', 'ring-white');
                btn.classList.remove('bg-green-600');
            }
        });
        chatWindow.innerHTML = '';
        showWelcomeMenu();
    }

    /** チャットウィンドウにユーザーのメッセージを表示 */
    function displayUserMessage(text) {
        const messageDiv = document.createElement('div');
        messageDiv.className = 'flex justify-end';
        const bubble = document.createElement('div');
        bubble.className = 'max-w-md p-3 rounded-2xl shadow bg-green-600 text-white';
        bubble.textContent = text;
        messageDiv.appendChild(bubble);
        chatWindow.appendChild(messageDiv);
        chatWindow.scrollTop = chatWindow.scrollHeight;
    }

    /** ボットの応答を表示（リッチコンテンツ対応） */
    function displayBotMessage(text, options = {}) {
        const messageContainer = document.createElement('div');
        messageContainer.className = 'flex flex-col items-start space-y-2';

        const bubble = document.createElement('div');
        bubble.className = 'max-w-md p-4 rounded-2xl shadow bg-white text-gray-800';
        
        const mainText = document.createElement('p');
        mainText.innerHTML = text.replace(/\n/g, '<br>');
        bubble.appendChild(mainText);
        
        const langContent = uiStrings[currentLanguage];

        if (options.dos || options.donts) {
            bubble.appendChild(document.createElement('hr'));
            if (options.dos) {
                const dosTitle = document.createElement('h4');
                dosTitle.className = 'font-bold mt-2 bot-response-dos';
                dosTitle.textContent = '✅ ' + (currentLanguage === 'ja' ? 'すべきこと' : currentLanguage === 'en' ? 'Do\'s' : '应该做的事');
                bubble.appendChild(dosTitle);
                const dosList = document.createElement('ul');
                dosList.className = 'list-disc list-inside text-sm';
                options.dos.forEach(item => { const li = document.createElement('li'); li.textContent = item; dosList.appendChild(li); });
                bubble.appendChild(dosList);
            }
            if (options.donts) {
                const dontsTitle = document.createElement('h4');
                dontsTitle.className = 'font-bold mt-2 bot-response-donts';
                dontsTitle.textContent = '❌ ' + (currentLanguage === 'ja' ? '避けるべきこと' : currentLanguage === 'en' ? 'Don\'ts' : '应该避免的事');
                bubble.appendChild(dontsTitle);
                const dontsList = document.createElement('ul');
                dontsList.className = 'list-disc list-inside text-sm';
                options.donts.forEach(item => { const li = document.createElement('li'); li.textContent = item; dontsList.appendChild(li); });
                bubble.appendChild(dontsList);
            }
        }
        
        if (options.link) {
            const link = document.createElement('a');
            link.href = options.link;
            link.target = '_blank';
            link.className = 'text-green-600 hover:underline text-sm font-semibold mt-3 block';
            link.textContent = '▶ ' + (currentLanguage === 'ja' ? 'もっと詳しく見る' : currentLanguage === 'en' ? 'Learn More' : '查看详情');
            bubble.appendChild(link);
        }

        messageContainer.appendChild(bubble);

        const repliesContainer = document.createElement('div');
        repliesContainer.className = 'flex justify-start flex-wrap gap-2 pt-1';
        
        const replies = options.quickReplies || options.quizOptions;
        if (replies) {
             replies.forEach(replyText => {
                const replyBtn = document.createElement('button');
                replyBtn.textContent = replyText;
                replyBtn.className = 'quick-reply-btn bg-white border border-green-500 text-green-500 text-sm font-semibold py-1 px-4 rounded-full hover:bg-green-500 hover:text-white transition';
                if(options.quizOptions) replyBtn.dataset.quizOption = "true";
                repliesContainer.appendChild(replyBtn);
            });
        }
        
        const isDetailView = options.dos || options.donts || options.link;
        if (isDetailView || options.isQuizResult) {
            const backBtn = document.createElement('button');
            backBtn.textContent = uiStrings[currentLanguage].back_to_menu;
            backBtn.className = 'quick-reply-btn bg-gray-200 border border-gray-400 text-gray-700 text-sm font-semibold py-1 px-4 rounded-full hover:bg-gray-300 transition';
            backBtn.dataset.action = 'back_to_menu';
            repliesContainer.appendChild(backBtn);
        }

        if (repliesContainer.hasChildNodes()) {
           messageContainer.appendChild(repliesContainer);
        }
        
        chatWindow.appendChild(messageContainer);
        chatWindow.scrollTop = chatWindow.scrollHeight;
    }

    /** ユーザーの入力を処理するメイン関数 */
    function handleUserInput() {
        const inputText = userInput.value.trim();
        if (!inputText) return;
        displayUserMessage(inputText);
        userInput.value = '';

        setTimeout(() => {
            const inquiryStrings = uiStrings[currentLanguage].inquiry;
            const cancelKeywords = inquiryStrings.cancel_keywords || [];
            
            if (inquiryState.status !== 'idle' && cancelKeywords.includes(inputText.toLowerCase())) {
                resetInquiryState();
                displayBotMessage(inquiryStrings.cancelled);
                setTimeout(showWelcomeMenu, 2000);
                return;
            }

            if (inquiryState.status !== 'idle') {
                processInquiry(inputText);
            } else {
                getBotResponse(inputText);
            }
        }, 500);
    }
    
    /** お問い合わせフローを処理 */
    function processInquiry(text) {
        const strings = uiStrings[currentLanguage].inquiry;
        switch(inquiryState.status) {
            case 'awaiting_name':
                inquiryState.name = text;
                inquiryState.status = 'awaiting_email';
                displayBotMessage(strings.prompt_email);
                break;
            case 'awaiting_email':
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                if (emailRegex.test(text)) {
                    inquiryState.email = text;
                    inquiryState.status = 'awaiting_message';
                    displayBotMessage(strings.prompt_message);
                } else {
                    displayBotMessage(strings.invalid_email);
                }
                break;
            case 'awaiting_message':
                inquiryState.message = text;
                sendInquiryToServer();
                break;
        }
    }
    
    /** [UPDATED] サーバーにお問い合わせ内容を送信（シミュレーション）*/
    function sendInquiryToServer() {
        displayBotMessage("..."); // ローディング表示

        // --- シミュレーション ---
        // 実際のサーバーがないため、ここではAPI通信をシミュレートします。
        // `fetch`は相対パス('send_inquiry.php')を解決できないためエラーになります。
        // 実際の環境では、このシミュレーション部分を削除し、下のコメントアウトされた
        // 元のコードを有効にし、'send_inquiry.php'をサーバー上の完全なURLに置き換えてください。
        new Promise((resolve, reject) => {
            setTimeout(() => {
                // 成功したと仮定して処理を続行
                 resolve({ success: true }); 
            }, 1500);
        })
        .then(result => {
            // ローディング表示を削除
            if (chatWindow.lastChild) {
                chatWindow.removeChild(chatWindow.lastChild);
            }
            if (result.success) {
                displayBotMessage(uiStrings[currentLanguage].inquiry.complete);
            } else {
                displayBotMessage(uiStrings[currentLanguage].inquiry.send_error);
            }
        })
        .catch(error => {
            console.error('Simulated fetch error:', error);
            // ローディング表示を削除
            if (chatWindow.lastChild) {
               chatWindow.removeChild(chatWindow.lastChild);
            }
            displayBotMessage(uiStrings[currentLanguage].inquiry.send_error);
        })
        .finally(() => {
            resetInquiryState();
            setTimeout(showWelcomeMenu, 3000);
        });
    }

    /** 通常の応答を検索して表示 */
    function getBotResponse(text) {
        const lowerCaseText = text.toLowerCase();
        const responses = knowledgeBase[currentLanguage];
        let foundReply = null;

        for (const keyword in responses) {
            if (lowerCaseText.includes(keyword.toLowerCase())) {
                foundReply = responses[keyword];
                break;
            }
        }

        if (foundReply) {
            if (foundReply.isInquiry) {
                inquiryState.status = 'awaiting_name';
                displayBotMessage(uiStrings[currentLanguage].inquiry.start);
            } else if (foundReply.isQuiz) {
                displayBotMessage(foundReply.question, { quizOptions: foundReply.options });
            } else {
                const message = {
                    ja: `「${text}」のマナーですね。`,
                    en: `Here are some manners for "${text}".`,
                    zh: `是关于「${text}」的礼仪呢。`
                }[currentLanguage];
                displayBotMessage(message, foundReply);
            }
        } else {
            displayBotMessage(uiStrings[currentLanguage].defaultReply);
        }
    }

    // --- イベントリスナー ---
    sendBtn.addEventListener('click', handleUserInput);
    userInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') handleUserInput();
    });

    /** ボタンクリックのイベントハンドラ */
    chatWindow.addEventListener('click', function(e) {
        if (!e.target.classList.contains('quick-reply-btn')) return;

        const replyText = e.target.textContent;
        const action = e.target.dataset.action;
        const isQuizOption = e.target.dataset.quizOption === "true";

        displayUserMessage(replyText);
        
        const buttonContainer = e.target.parentElement;
        if (buttonContainer) buttonContainer.remove();

        if (action === 'back_to_menu') {
            setTimeout(showWelcomeMenu, 500);
        } else if (isQuizOption) {
            const quizData = knowledgeBase[currentLanguage]['クイズ'] || knowledgeBase[currentLanguage]['quiz'] || knowledgeBase[currentLanguage]['测验'];
            let resultMessage;
            const correctMessages = { ja: '正解です！👏 ', en: 'Correct! 👏 ', zh: '回答正确！👏 ' };
            const incorrectMessages = { ja: '残念！正解は「', en: 'Incorrect. The correct answer is "', zh: '很遗憾！正确答案是“' };
            const endMessages = { ja: '」です。', en: '". ', zh: '”。' };

            if(replyText === quizData.correct) {
                 resultMessage = correctMessages[currentLanguage] + quizData.explanation;
            } else {
                 resultMessage = incorrectMessages[currentLanguage] + quizData.correct + endMessages[currentLanguage] + quizData.explanation;
            }
            setTimeout(() => displayBotMessage(resultMessage, { isQuizResult: true }), 500);
        } else {
            setTimeout(() => getBotResponse(replyText), 500);
        }
    });
    
    // --- 初期化 ---
    switchLanguage('ja');

    /*
    =============================================================================
    PHPコードのサンプル (send_inquiry.php)
    =============================================================================
    
    <?php
    header('Content-Type: application/json; charset=utf-8');
    header('Access-Control-Allow-Origin: *'); 
    header('Access-Control-Allow-Methods: POST, OPTIONS');
    header('Access-Control-Allow-Headers: Content-Type');

    if ($_SERVER['REQUEST_METHOD'] == 'OPTIONS') {
        exit;
    }

    $json_data = file_get_contents('php://input');
    $request_data = json_decode($json_data, true);

    if (!$request_data || !isset($request_data['name']) || !isset($request_data['email']) || !isset($request_data['message'])) {
        echo json_encode(['success' => false, 'error' => 'Invalid input']);
        exit;
    }

    $name = filter_var(trim($request_data['name']), FILTER_SANITIZE_STRING);
    $email = filter_var(trim($request_data['email']), FILTER_SANITIZE_EMAIL);
    $message = filter_var(trim($request_data['message']), FILTER_SANITIZE_STRING);
    
    if (!filter_var($email, FILTER_VALIDATE_EMAIL)) {
         echo json_encode(['success' => false, 'error' => 'Invalid email format']);
         exit;
    }

    // ★★★ あなたのメールアドレスに変更してください ★★★
    $to = "your-email@example.com"; 
    
    $subject = "【マナー学習サイト】チャットボットからのお問い合わせ";

    $body = "チャットボット経由でお問い合わせがありました。\n\n";
    $body .= "================================\n";
    $body .= "お名前: " . $name . "\n";
    $body .= "メールアドレス: " . $email . "\n";
    $body .= "お問い合わせ内容:\n" . $message . "\n";
    $body .= "================================\n";

    // ★あなたのドメインのメールアドレスに変更
    $headers = "From: no-reply@your-domain.com\r\n"; 
    $headers .= "Reply-To: " . $email . "\r\n";
    $headers .= "Content-Type: text/plain; charset=UTF-8\r\n";
    $headers .= "X-Mailer: PHP/" . phpversion();

    if (mail($to, $subject, $body, $headers)) {
        echo json_encode(['success' => true]);
    } else {
        echo json_encode(['success' => false, 'error' => 'Failed to send mail']);
    }

    ?>
    */
</script>

</body>
</html>
