<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒãƒŠãƒ¼å­¦ç¿’ãƒãƒ£ãƒƒãƒˆãƒœãƒƒãƒˆ ãƒ‡ãƒ¢</title>
    
    <!-- Tailwind CSSã¨Google Fontsã®èª­ã¿è¾¼ã¿ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+JP:wght@400;500;700&family=Noto+Sans+SC:wght@400;500;700&display=swap" rel="stylesheet">
    
    <style>
        body {
            font-family: 'Inter', 'Noto Sans JP', 'Noto Sans SC', sans-serif;
        }
        #chat-window::-webkit-scrollbar { width: 8px; }
        #chat-window::-webkit-scrollbar-track { background: #f1f5f9; }
        #chat-window::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 4px; }
        #chat-window::-webkit-scrollbar-thumb:hover { background: #64748b; }
        .bot-response-dos { color: #16a34a; /* Green */ }
        .bot-response-donts { color: #dc2626; /* Red */ }
    </style>
</head>

<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">

    <div class="w-full max-w-lg mx-auto bg-white rounded-2xl shadow-2xl flex flex-col h-[90vh] max-h-[750px]">
        
        <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
        <header class="bg-green-700 text-white p-4 rounded-t-2xl shadow-md flex justify-between items-center">
            <div>
                <h1 id="header-title" class="text-xl font-bold">ãƒãƒŠãƒ¼å­¦ç¿’ãƒœãƒƒãƒˆ</h1>
                <p id="header-lang-status" class="text-sm opacity-90">è¨€èª: æ—¥æœ¬èª</p>
            </div>
            <div id="language-switcher" class="flex space-x-1 sm:space-x-2">
                <button onclick="switchLanguage('ja')" class="ja-btn bg-white text-green-700 font-bold py-1 px-3 rounded-full text-sm shadow-sm transition-transform transform scale-110 ring-2 ring-white">æ—¥æœ¬èª</button>
                <button onclick="switchLanguage('en')" class="en-btn bg-green-600 hover:bg-white hover:text-green-700 font-bold py-1 px-3 rounded-full text-sm shadow-sm transition-transform transform hover:scale-110">EN</button>
                <button onclick="switchLanguage('zh')" class="zh-btn bg-green-600 hover:bg-white hover:text-green-700 font-bold py-1 px-3 rounded-full text-sm shadow-sm transition-transform transform hover:scale-110">ä¸­æ–‡</button>
            </div>
        </header>

        <!-- ãƒãƒ£ãƒƒãƒˆã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ -->
        <main id="chat-window" class="flex-1 p-6 overflow-y-auto space-y-4 bg-gray-50">
            <!-- ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯ã“ã“ã«å‹•çš„ã«è¿½åŠ  -->
        </main>

        <!-- å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ  -->
        <footer class="p-4 bg-white border-t border-gray-200 rounded-b-2xl">
            <div class="flex items-center space-x-3">
                <input type="text" id="user-input" class="flex-1 p-3 border border-gray-300 rounded-full focus:outline-none focus:ring-2 focus:ring-green-500 transition" placeholder="ã€Œé£Ÿäº‹ã®ãƒãƒŠãƒ¼ã€ã®ã‚ˆã†ã«å…¥åŠ›">
                <button id="send-btn" class="bg-green-600 text-white rounded-full p-3 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition-transform transform hover:scale-110">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" /></svg>
                </button>
            </div>
        </footer>
    </div>

<script>
    // --- ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•° ---
    let currentLanguage = 'ja';
    let inquiryState = {
        status: 'idle', // idle, awaiting_name, awaiting_email, awaiting_message
        name: '',
        email: '',
        message: ''
    };

    // --- DOMè¦ç´  ---
    const chatWindow = document.getElementById('chat-window');
    const userInput = document.getElementById('user-input');
    const sendBtn = document.getElementById('send-btn');
    const langSwitcher = document.getElementById('language-switcher');

    // --- å¤šè¨€èªUIãƒ†ã‚­ã‚¹ãƒˆ ---
    const uiStrings = {
        ja: {
            headerTitle: 'ãƒãƒŠãƒ¼å­¦ç¿’ãƒœãƒƒãƒˆ',
            langStatus: 'è¨€èª: æ—¥æœ¬èª',
            inputPlaceholder: 'ã€Œé£Ÿäº‹ã®ãƒãƒŠãƒ¼ã€ã®ã‚ˆã†ã«å…¥åŠ›',
            welcome: {
                message: 'ã“ã‚“ã«ã¡ã¯ï¼æ—¥æœ¬ã®ãƒãƒŠãƒ¼ã«ã¤ã„ã¦ã€ã©ã‚“ãªã“ã¨ã‚’çŸ¥ã‚ŠãŸã„ã§ã™ã‹ï¼Ÿä¸‹ã®ãƒœã‚¿ãƒ³ã‹ã‚‰é¸ã¶ã‹ã€ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚',
                replies: ['é£Ÿäº‹', 'é›»è»Š', 'ã‚¯ã‚¤ã‚º', 'ãŠå•ã„åˆã‚ã›']
            },
            defaultReply: 'ç”³ã—è¨³ã‚ã‚Šã¾ã›ã‚“ã€ãã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã«é–¢ã™ã‚‹æƒ…å ±ã¯è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚åˆ¥ã®è¨€è‘‰ã§ãŠè©¦ã—ãã ã•ã„ã€‚',
            back_to_menu: 'ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã«æˆ»ã‚‹',
            inquiry: {
                start: 'ãŠå•ã„åˆã‚ã›ã§ã™ã­ã€‚æ‰¿çŸ¥ã„ãŸã—ã¾ã—ãŸã€‚ã¾ãšã€ãŠåå‰ã‚’æ•™ãˆã¦ã„ãŸã ã‘ã¾ã™ã‹ï¼Ÿï¼ˆé€”ä¸­ã§ã€Œã‚­ãƒ£ãƒ³ã‚»ãƒ«ã€ã¨å…¥åŠ›ã™ã‚‹ã¨ä¸­æ–­ã§ãã¾ã™ï¼‰',
                prompt_email: 'ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ã€‚æ¬¡ã«ã€ã”é€£çµ¡å…ˆã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’ãŠé¡˜ã„ã—ã¾ã™ã€‚',
                prompt_message: 'æ‰¿çŸ¥ã„ãŸã—ã¾ã—ãŸã€‚æœ€å¾Œã«ãŠå•ã„åˆã‚ã›å†…å®¹ã‚’ã”è¨˜å…¥ãã ã•ã„ã€‚',
                complete: 'ãŠå•ã„åˆã‚ã›ã„ãŸã ãã€ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ã€‚æ‹…å½“è€…ã‚ˆã‚Šè¿½ã£ã¦ã”é€£çµ¡ã„ãŸã—ã¾ã™ã€‚',
                invalid_email: 'ç”³ã—è¨³ã‚ã‚Šã¾ã›ã‚“ãŒã€ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã®å½¢å¼ãŒæ­£ã—ããªã„ã‚ˆã†ã§ã™ã€‚ã‚‚ã†ä¸€åº¦å…¥åŠ›ã—ã¦ã„ãŸã ã‘ã¾ã™ã‹ï¼Ÿ',
                send_error: 'ç”³ã—è¨³ã‚ã‚Šã¾ã›ã‚“ã€é€ä¿¡ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚æ™‚é–“ã‚’ãŠã„ã¦å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚',
                cancelled: 'ãŠå•ã„åˆã‚ã›ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã—ãŸã€‚',
                cancel_keywords: ['ã‚­ãƒ£ãƒ³ã‚»ãƒ«', 'ã‚„ã‚ã‚‹'],
            }
        },
        en: {
            headerTitle: 'Manners Learning Bot',
            langStatus: 'Language: English',
            inputPlaceholder: 'e.g., "dining manners"',
            welcome: {
                message: 'Hello! What would you like to know about Japanese manners? Choose from the buttons below or type a keyword.',
                replies: ['Dining', 'Trains', 'Quiz', 'Contact']
            },
            defaultReply: "I'm sorry, I couldn't find information on that topic. Please try another keyword.",
            back_to_menu: 'Back to Menu',
            inquiry: {
                start: 'Okay, you want to make an inquiry. First, could you please tell me your name? (You can type "cancel" to stop at any time)',
                prompt_email: 'Thank you. Next, please provide your email address.',
                prompt_message: 'Got it. Finally, please enter your message.',
                complete: 'Thank you for your inquiry. Our team will get back to you shortly.',
                invalid_email: "I'm sorry, but the email address format seems incorrect. Could you please enter it again?",
                send_error: 'Sorry, an error occurred while sending. Please try again later.',
                cancelled: 'The inquiry has been cancelled.',
                cancel_keywords: ['cancel', 'stop'],
            }
        },
        zh: {
            headerTitle: 'ç¤¼ä»ªå­¦ä¹ æœºå™¨äºº',
            langStatus: 'è¯­è¨€: ä¸­æ–‡',
            inputPlaceholder: 'ä¾‹å¦‚è¾“å…¥â€œé¤é¥®ç¤¼ä»ªâ€',
            welcome: {
                message: 'æ‚¨å¥½ï¼å…³äºæ—¥æœ¬çš„ç¤¼ä»ªï¼Œæ‚¨æƒ³äº†è§£ä»€ä¹ˆï¼Ÿè¯·ä»ä¸‹é¢çš„æŒ‰é’®ä¸­é€‰æ‹©æˆ–è¾“å…¥å…³é”®è¯ã€‚',
                replies: ['é¤é¥®', 'ç”µè½¦', 'æµ‹éªŒ', 'è”ç³»æˆ‘ä»¬']
            },
            defaultReply: 'å¾ˆæŠ±æ­‰ï¼Œæœªèƒ½æ‰¾åˆ°ç›¸å…³ä¿¡æ¯ã€‚è¯·æ¢ä¸ªå…³é”®è¯è¯•è¯•ã€‚',
            back_to_menu: 'è¿”å›èœå•',
            inquiry: {
                start: 'å¥½çš„ï¼Œæ‚¨æƒ³è¿›è¡Œå’¨è¯¢ã€‚é¦–å…ˆï¼Œè¯·é—®æ‚¨çš„åå­—æ˜¯ï¼Ÿï¼ˆæ‚¨å¯ä»¥éšæ—¶è¾“å…¥â€œå–æ¶ˆâ€æ¥ä¸­æ–­ï¼‰',
                prompt_email: 'è°¢è°¢ã€‚æ¥ä¸‹æ¥ï¼Œè¯·è¾“å…¥æ‚¨çš„ç”µå­é‚®ä»¶åœ°å€ã€‚',
                prompt_message: 'å¥½çš„ã€‚æœ€åï¼Œè¯·è¾“å…¥æ‚¨çš„å’¨è¯¢å†…å®¹ã€‚',
                complete: 'æ„Ÿè°¢æ‚¨çš„å’¨è¯¢ï¼Œç›¸å…³äººå‘˜ä¼šå°½å¿«ä¸æ‚¨è”ç³»ã€‚',
                invalid_email: 'æŠ±æ­‰ï¼Œç”µå­é‚®ä»¶åœ°å€çš„æ ¼å¼ä¼¼ä¹ä¸æ­£ç¡®ï¼Œå¯ä»¥è¯·æ‚¨å†è¾“å…¥ä¸€æ¬¡å—ï¼Ÿ',
                send_error: 'æŠ±æ­‰ï¼Œå‘é€æ—¶å‘ç”Ÿé”™è¯¯ï¼Œè¯·ç¨åå†è¯•ã€‚',
                cancelled: 'å’¨è¯¢å·²å–æ¶ˆã€‚',
                cancel_keywords: ['å–æ¶ˆ'],
            }
        }
    };

    // --- ãƒŠãƒ¬ãƒƒã‚¸ãƒ™ãƒ¼ã‚¹ ---
    const knowledgeBase = {
        ja: {
            'é£Ÿäº‹': { dos: ['ã€Œã„ãŸã ãã¾ã™ã€ã€Œã”ã¡ãã†ã•ã¾ã€ã‚’è¨€ã†', 'ãŠç®¸ã‚’æ­£ã—ãæŒã¤'], donts: ['ç®¸ã‚’ã”é£¯ã«çªãåˆºã™ï¼ˆç«‹ã¦ç®¸ï¼‰', 'éŸ³ã‚’ç«‹ã¦ã¦é£Ÿã¹ã‚‹'], link: '/articles/dining-etiquette' },
            'é›»è»Š': { dos: ['é™ã‹ã«ä¹—è»Šã™ã‚‹', 'ãŠå¹´å¯„ã‚Šã‚„å¦Šå©¦ã®æ–¹ã«å¸­ã‚’è­²ã‚‹'], donts: ['è»Šå†…ã§å¤§å£°ã§è©±ã™', 'å¤§ããªè·ç‰©ã§é€šè·¯ã‚’ãµã•ã'], link: '/articles/train-manners' },
            'ã‚¯ã‚¤ã‚º': { isQuiz: true, question: 'ãƒ¬ã‚¹ãƒˆãƒ©ãƒ³ã§ã€å…¥ã‚Šå£ã‹ã‚‰ä¸€ç•ªé ã„å¸­ã¯èª°ãŒåº§ã‚‹å¸­ã§ã—ã‚‡ã†ã‹ï¼Ÿ', options: ['ä¸€ç•ªå‰ã„äºº', 'ä¸€ç•ªè‹¥ã„äºº', 'èª°ã§ã‚‚è‰¯ã„'], correct: 'ä¸€ç•ªå‰ã„äºº', explanation: 'æ—¥æœ¬ã§ã¯ã€å…¥ã‚Šå£ã‹ã‚‰æœ€ã‚‚é ã„å¸­ãŒã€Œä¸Šåº§ï¼ˆã‹ã¿ã–ï¼‰ã€ã¨ã•ã‚Œã€æœ€ã‚‚æ•¬æ„ã‚’æ‰•ã†ã¹ãäººãŒåº§ã‚‹ã®ãŒä¸€èˆ¬çš„ã§ã™ã€‚' },
            'ãŠå•ã„åˆã‚ã›': { isInquiry: true }
        },
        en: {
            'dining': { dos: ['Say "itadakimasu" and "gochisosama"', 'Hold chopsticks correctly'], donts: ['Sticking chopsticks upright in your rice', 'Making loud noises while eating'], link: '/en/articles/dining-etiquette' },
            'trains': { dos: ['Be quiet on the train', 'Offer your seat to the elderly'], donts: ['Talking loudly or on the phone', 'Blocking the aisle with large luggage'], link: '/en/articles/train-manners' },
            'quiz': { isQuiz: true, question: 'In a restaurant, who sits in the seat furthest from the entrance?', options: ['The most important person', 'The youngest person', 'Anyone'], correct: 'The most important person', explanation: 'In Japan, the seat furthest from the entrance is called "kamiza," and it is for the most respected person.' },
            'contact': { isInquiry: true }
        },
        zh: {
            'é¤é¥®': { dos: ['åƒé¥­å‰åè¯´â€œæˆ‘å¼€åŠ¨äº†â€å’Œâ€œæˆ‘åƒå¥½äº†â€', 'æ­£ç¡®ä½¿ç”¨ç­·å­'], donts: ['æŠŠç­·å­æ’åœ¨ç±³é¥­ä¸Š', 'åƒé¥­æ—¶å‘å‡ºå¾ˆå¤§å£°éŸ³'], link: '/zh/articles/dining-etiquette' },
            'ç”µè½¦': { dos: ['å®‰é™ä¹˜è½¦', 'ç»™è€äººæˆ–å­•å¦‡è®©åº§'], donts: ['åœ¨è½¦å¢å†…å¤§å£°è¯´è¯æˆ–æ‰“ç”µè¯', 'ç”¨å¤§ä»¶è¡Œæå µä½é€šé“'], link: '/zh/articles/train-manners' },
            'æµ‹éªŒ': { isQuiz: true, question: 'åœ¨é¤å…é‡Œï¼Œç¦»å…¥å£æœ€è¿œçš„åº§ä½æ˜¯ç»™è°åçš„ï¼Ÿ', options: ['åœ°ä½æœ€é«˜çš„äºº', 'æœ€å¹´è½»çš„äºº', 'ä»»ä½•äººéƒ½å¯ä»¥'], correct: 'åœ°ä½æœ€é«˜çš„äºº', explanation: 'åœ¨æ—¥æœ¬ï¼Œç¦»å…¥å£æœ€è¿œçš„åº§ä½è¢«ç§°ä¸ºâ€œä¸Šåº§â€ï¼Œé€šå¸¸æ˜¯ç»™æœ€åº”å—å°Šæ•¬çš„äººåçš„ã€‚' },
            'è”ç³»æˆ‘ä»¬': { isInquiry: true }
        }
    };
    
    // --- é–¢æ•°å®šç¾© ---

    /** ãŠå•ã„åˆã‚ã›ã®çŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆ */
    function resetInquiryState() {
        inquiryState = { status: 'idle', name: '', email: '', message: '' };
    }
    
    /** ã‚¦ã‚§ãƒ«ã‚«ãƒ ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’è¡¨ç¤º */
    function showWelcomeMenu() {
        const welcome = uiStrings[currentLanguage].welcome;
        displayBotMessage(welcome.message, { quickReplies: welcome.replies });
    }

    /** è¨€èªã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹ */
    function switchLanguage(lang) {
        currentLanguage = lang;
        resetInquiryState();
        const strings = uiStrings[lang];
        document.getElementById('header-title').textContent = strings.headerTitle;
        document.getElementById('header-lang-status').textContent = strings.langStatus;
        userInput.placeholder = strings.inputPlaceholder;

        const buttons = langSwitcher.querySelectorAll('button');
        buttons.forEach(btn => {
            btn.classList.remove('bg-white', 'text-green-700', 'scale-110', 'ring-2', 'ring-white');
            btn.classList.add('bg-green-600', 'hover:bg-white', 'hover:text-green-700');
            if (btn.classList.contains(`${lang}-btn`)) {
                btn.classList.add('bg-white', 'text-green-700', 'scale-110', 'ring-2', 'ring-white');
                btn.classList.remove('bg-green-600');
            }
        });
        chatWindow.innerHTML = '';
        showWelcomeMenu();
    }

    /** ãƒãƒ£ãƒƒãƒˆã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã«ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º */
    function displayUserMessage(text) {
        const messageDiv = document.createElement('div');
        messageDiv.className = 'flex justify-end';
        const bubble = document.createElement('div');
        bubble.className = 'max-w-md p-3 rounded-2xl shadow bg-green-600 text-white';
        bubble.textContent = text;
        messageDiv.appendChild(bubble);
        chatWindow.appendChild(messageDiv);
        chatWindow.scrollTop = chatWindow.scrollHeight;
    }

    /** ãƒœãƒƒãƒˆã®å¿œç­”ã‚’è¡¨ç¤ºï¼ˆãƒªãƒƒãƒã‚³ãƒ³ãƒ†ãƒ³ãƒ„å¯¾å¿œï¼‰ */
    function displayBotMessage(text, options = {}) {
        const messageContainer = document.createElement('div');
        messageContainer.className = 'flex flex-col items-start space-y-2';

        const bubble = document.createElement('div');
        bubble.className = 'max-w-md p-4 rounded-2xl shadow bg-white text-gray-800';
        
        const mainText = document.createElement('p');
        mainText.innerHTML = text.replace(/\n/g, '<br>');
        bubble.appendChild(mainText);
        
        const langContent = uiStrings[currentLanguage];

        if (options.dos || options.donts) {
            bubble.appendChild(document.createElement('hr'));
            if (options.dos) {
                const dosTitle = document.createElement('h4');
                dosTitle.className = 'font-bold mt-2 bot-response-dos';
                dosTitle.textContent = 'âœ… ' + (currentLanguage === 'ja' ? 'ã™ã¹ãã“ã¨' : currentLanguage === 'en' ? 'Do\'s' : 'åº”è¯¥åšçš„äº‹');
                bubble.appendChild(dosTitle);
                const dosList = document.createElement('ul');
                dosList.className = 'list-disc list-inside text-sm';
                options.dos.forEach(item => { const li = document.createElement('li'); li.textContent = item; dosList.appendChild(li); });
                bubble.appendChild(dosList);
            }
            if (options.donts) {
                const dontsTitle = document.createElement('h4');
                dontsTitle.className = 'font-bold mt-2 bot-response-donts';
                dontsTitle.textContent = 'âŒ ' + (currentLanguage === 'ja' ? 'é¿ã‘ã‚‹ã¹ãã“ã¨' : currentLanguage === 'en' ? 'Don\'ts' : 'åº”è¯¥é¿å…çš„äº‹');
                bubble.appendChild(dontsTitle);
                const dontsList = document.createElement('ul');
                dontsList.className = 'list-disc list-inside text-sm';
                options.donts.forEach(item => { const li = document.createElement('li'); li.textContent = item; dontsList.appendChild(li); });
                bubble.appendChild(dontsList);
            }
        }
        
        if (options.link) {
            const link = document.createElement('a');
            link.href = options.link;
            link.target = '_blank';
            link.className = 'text-green-600 hover:underline text-sm font-semibold mt-3 block';
            link.textContent = 'â–¶ ' + (currentLanguage === 'ja' ? 'ã‚‚ã£ã¨è©³ã—ãè¦‹ã‚‹' : currentLanguage === 'en' ? 'Learn More' : 'æŸ¥çœ‹è¯¦æƒ…');
            bubble.appendChild(link);
        }

        messageContainer.appendChild(bubble);

        const repliesContainer = document.createElement('div');
        repliesContainer.className = 'flex justify-start flex-wrap gap-2 pt-1';
        
        const replies = options.quickReplies || options.quizOptions;
        if (replies) {
             replies.forEach(replyText => {
                const replyBtn = document.createElement('button');
                replyBtn.textContent = replyText;
                replyBtn.className = 'quick-reply-btn bg-white border border-green-500 text-green-500 text-sm font-semibold py-1 px-4 rounded-full hover:bg-green-500 hover:text-white transition';
                if(options.quizOptions) replyBtn.dataset.quizOption = "true";
                repliesContainer.appendChild(replyBtn);
            });
        }
        
        const isDetailView = options.dos || options.donts || options.link;
        if (isDetailView || options.isQuizResult) {
            const backBtn = document.createElement('button');
            backBtn.textContent = uiStrings[currentLanguage].back_to_menu;
            backBtn.className = 'quick-reply-btn bg-gray-200 border border-gray-400 text-gray-700 text-sm font-semibold py-1 px-4 rounded-full hover:bg-gray-300 transition';
            backBtn.dataset.action = 'back_to_menu';
            repliesContainer.appendChild(backBtn);
        }

        if (repliesContainer.hasChildNodes()) {
           messageContainer.appendChild(repliesContainer);
        }
        
        chatWindow.appendChild(messageContainer);
        chatWindow.scrollTop = chatWindow.scrollHeight;
    }

    /** ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å…¥åŠ›ã‚’å‡¦ç†ã™ã‚‹ãƒ¡ã‚¤ãƒ³é–¢æ•° */
    function handleUserInput() {
        const inputText = userInput.value.trim();
        if (!inputText) return;
        displayUserMessage(inputText);
        userInput.value = '';

        setTimeout(() => {
            const inquiryStrings = uiStrings[currentLanguage].inquiry;
            const cancelKeywords = inquiryStrings.cancel_keywords || [];
            
            if (inquiryState.status !== 'idle' && cancelKeywords.includes(inputText.toLowerCase())) {
                resetInquiryState();
                displayBotMessage(inquiryStrings.cancelled);
                setTimeout(showWelcomeMenu, 2000);
                return;
            }

            if (inquiryState.status !== 'idle') {
                processInquiry(inputText);
            } else {
                getBotResponse(inputText);
            }
        }, 500);
    }
    
    /** ãŠå•ã„åˆã‚ã›ãƒ•ãƒ­ãƒ¼ã‚’å‡¦ç† */
    function processInquiry(text) {
        const strings = uiStrings[currentLanguage].inquiry;
        switch(inquiryState.status) {
            case 'awaiting_name':
                inquiryState.name = text;
                inquiryState.status = 'awaiting_email';
                displayBotMessage(strings.prompt_email);
                break;
            case 'awaiting_email':
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                if (emailRegex.test(text)) {
                    inquiryState.email = text;
                    inquiryState.status = 'awaiting_message';
                    displayBotMessage(strings.prompt_message);
                } else {
                    displayBotMessage(strings.invalid_email);
                }
                break;
            case 'awaiting_message':
                inquiryState.message = text;
                sendInquiryToServer();
                break;
        }
    }
    
    /** [UPDATED] ã‚µãƒ¼ãƒãƒ¼ã«ãŠå•ã„åˆã‚ã›å†…å®¹ã‚’é€ä¿¡ï¼ˆã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ï¼‰*/
    function sendInquiryToServer() {
        displayBotMessage("..."); // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º

        // --- ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ ---
        // å®Ÿéš›ã®ã‚µãƒ¼ãƒãƒ¼ãŒãªã„ãŸã‚ã€ã“ã“ã§ã¯APIé€šä¿¡ã‚’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆã—ã¾ã™ã€‚
        // `fetch`ã¯ç›¸å¯¾ãƒ‘ã‚¹('send_inquiry.php')ã‚’è§£æ±ºã§ããªã„ãŸã‚ã‚¨ãƒ©ãƒ¼ã«ãªã‚Šã¾ã™ã€‚
        // å®Ÿéš›ã®ç’°å¢ƒã§ã¯ã€ã“ã®ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³éƒ¨åˆ†ã‚’å‰Šé™¤ã—ã€ä¸‹ã®ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆã•ã‚ŒãŸ
        // å…ƒã®ã‚³ãƒ¼ãƒ‰ã‚’æœ‰åŠ¹ã«ã—ã€'send_inquiry.php'ã‚’ã‚µãƒ¼ãƒãƒ¼ä¸Šã®å®Œå…¨ãªURLã«ç½®ãæ›ãˆã¦ãã ã•ã„ã€‚
        new Promise((resolve, reject) => {
            setTimeout(() => {
                // æˆåŠŸã—ãŸã¨ä»®å®šã—ã¦å‡¦ç†ã‚’ç¶šè¡Œ
                 resolve({ success: true }); 
            }, 1500);
        })
        .then(result => {
            // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤ºã‚’å‰Šé™¤
            if (chatWindow.lastChild) {
                chatWindow.removeChild(chatWindow.lastChild);
            }
            if (result.success) {
                displayBotMessage(uiStrings[currentLanguage].inquiry.complete);
            } else {
                displayBotMessage(uiStrings[currentLanguage].inquiry.send_error);
            }
        })
        .catch(error => {
            console.error('Simulated fetch error:', error);
            // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤ºã‚’å‰Šé™¤
            if (chatWindow.lastChild) {
               chatWindow.removeChild(chatWindow.lastChild);
            }
            displayBotMessage(uiStrings[currentLanguage].inquiry.send_error);
        })
        .finally(() => {
            resetInquiryState();
            setTimeout(showWelcomeMenu, 3000);
        });
    }

    /** é€šå¸¸ã®å¿œç­”ã‚’æ¤œç´¢ã—ã¦è¡¨ç¤º */
    function getBotResponse(text) {
        const lowerCaseText = text.toLowerCase();
        const responses = knowledgeBase[currentLanguage];
        let foundReply = null;

        for (const keyword in responses) {
            if (lowerCaseText.includes(keyword.toLowerCase())) {
                foundReply = responses[keyword];
                break;
            }
        }

        if (foundReply) {
            if (foundReply.isInquiry) {
                inquiryState.status = 'awaiting_name';
                displayBotMessage(uiStrings[currentLanguage].inquiry.start);
            } else if (foundReply.isQuiz) {
                displayBotMessage(foundReply.question, { quizOptions: foundReply.options });
            } else {
                const message = {
                    ja: `ã€Œ${text}ã€ã®ãƒãƒŠãƒ¼ã§ã™ã­ã€‚`,
                    en: `Here are some manners for "${text}".`,
                    zh: `æ˜¯å…³äºã€Œ${text}ã€çš„ç¤¼ä»ªå‘¢ã€‚`
                }[currentLanguage];
                displayBotMessage(message, foundReply);
            }
        } else {
            displayBotMessage(uiStrings[currentLanguage].defaultReply);
        }
    }

    // --- ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ ---
    sendBtn.addEventListener('click', handleUserInput);
    userInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') handleUserInput();
    });

    /** ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ© */
    chatWindow.addEventListener('click', function(e) {
        if (!e.target.classList.contains('quick-reply-btn')) return;

        const replyText = e.target.textContent;
        const action = e.target.dataset.action;
        const isQuizOption = e.target.dataset.quizOption === "true";

        displayUserMessage(replyText);
        
        const buttonContainer = e.target.parentElement;
        if (buttonContainer) buttonContainer.remove();

        if (action === 'back_to_menu') {
            setTimeout(showWelcomeMenu, 500);
        } else if (isQuizOption) {
            const quizData = knowledgeBase[currentLanguage]['ã‚¯ã‚¤ã‚º'] || knowledgeBase[currentLanguage]['quiz'] || knowledgeBase[currentLanguage]['æµ‹éªŒ'];
            let resultMessage;
            const correctMessages = { ja: 'æ­£è§£ã§ã™ï¼ğŸ‘ ', en: 'Correct! ğŸ‘ ', zh: 'å›ç­”æ­£ç¡®ï¼ğŸ‘ ' };
            const incorrectMessages = { ja: 'æ®‹å¿µï¼æ­£è§£ã¯ã€Œ', en: 'Incorrect. The correct answer is "', zh: 'å¾ˆé—æ†¾ï¼æ­£ç¡®ç­”æ¡ˆæ˜¯â€œ' };
            const endMessages = { ja: 'ã€ã§ã™ã€‚', en: '". ', zh: 'â€ã€‚' };

            if(replyText === quizData.correct) {
                 resultMessage = correctMessages[currentLanguage] + quizData.explanation;
            } else {
                 resultMessage = incorrectMessages[currentLanguage] + quizData.correct + endMessages[currentLanguage] + quizData.explanation;
            }
            setTimeout(() => displayBotMessage(resultMessage, { isQuizResult: true }), 500);
        } else {
            setTimeout(() => getBotResponse(replyText), 500);
        }
    });
    
    // --- åˆæœŸåŒ– ---
    switchLanguage('ja');

    /*
    =============================================================================
    PHPã‚³ãƒ¼ãƒ‰ã®ã‚µãƒ³ãƒ—ãƒ« (send_inquiry.php)
    =============================================================================
    
    <?php
    header('Content-Type: application/json; charset=utf-8');
    header('Access-Control-Allow-Origin: *'); 
    header('Access-Control-Allow-Methods: POST, OPTIONS');
    header('Access-Control-Allow-Headers: Content-Type');

    if ($_SERVER['REQUEST_METHOD'] == 'OPTIONS') {
        exit;
    }

    $json_data = file_get_contents('php://input');
    $request_data = json_decode($json_data, true);

    if (!$request_data || !isset($request_data['name']) || !isset($request_data['email']) || !isset($request_data['message'])) {
        echo json_encode(['success' => false, 'error' => 'Invalid input']);
        exit;
    }

    $name = filter_var(trim($request_data['name']), FILTER_SANITIZE_STRING);
    $email = filter_var(trim($request_data['email']), FILTER_SANITIZE_EMAIL);
    $message = filter_var(trim($request_data['message']), FILTER_SANITIZE_STRING);
    
    if (!filter_var($email, FILTER_VALIDATE_EMAIL)) {
         echo json_encode(['success' => false, 'error' => 'Invalid email format']);
         exit;
    }

    // â˜…â˜…â˜… ã‚ãªãŸã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã«å¤‰æ›´ã—ã¦ãã ã•ã„ â˜…â˜…â˜…
    $to = "your-email@example.com"; 
    
    $subject = "ã€ãƒãƒŠãƒ¼å­¦ç¿’ã‚µã‚¤ãƒˆã€‘ãƒãƒ£ãƒƒãƒˆãƒœãƒƒãƒˆã‹ã‚‰ã®ãŠå•ã„åˆã‚ã›";

    $body = "ãƒãƒ£ãƒƒãƒˆãƒœãƒƒãƒˆçµŒç”±ã§ãŠå•ã„åˆã‚ã›ãŒã‚ã‚Šã¾ã—ãŸã€‚\n\n";
    $body .= "================================\n";
    $body .= "ãŠåå‰: " . $name . "\n";
    $body .= "ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹: " . $email . "\n";
    $body .= "ãŠå•ã„åˆã‚ã›å†…å®¹:\n" . $message . "\n";
    $body .= "================================\n";

    // â˜…ã‚ãªãŸã®ãƒ‰ãƒ¡ã‚¤ãƒ³ã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã«å¤‰æ›´
    $headers = "From: no-reply@your-domain.com\r\n"; 
    $headers .= "Reply-To: " . $email . "\r\n";
    $headers .= "Content-Type: text/plain; charset=UTF-8\r\n";
    $headers .= "X-Mailer: PHP/" . phpversion();

    if (mail($to, $subject, $body, $headers)) {
        echo json_encode(['success' => true]);
    } else {
        echo json_encode(['success' => false, 'error' => 'Failed to send mail']);
    }

    ?>
    */
</script>

</body>
</html>
